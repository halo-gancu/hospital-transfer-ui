<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç—…é™¢æƒ…å ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

<!-- CSS -->
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/table.css">
<link rel="stylesheet" href="/css/responsive.css">

<!-- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³CSSï¼šåˆæœŸè¡¨ç¤ºåˆ¶å¾¡ -->
<style>
/* CSSå¤‰æ•°ã®ä¸Šæ›¸ã - æœ€å„ªå…ˆ */
:root {
  --rowh: 60px !important;
  --fac-rowh: 60px !important;
  --line: 1px solid #999;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ - æœ€å„ªå…ˆ */
#loading-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  z-index: 99999 !important;
  transition: opacity 0.3s ease !important;
}

#loading-overlay.fade-out {
  opacity: 0 !important;
  pointer-events: none !important;
}

.loading-content {
  text-align: center;
  color: white;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* åˆæœŸçŠ¶æ…‹ï¼šã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º */
body:not(.content-loaded) .nav-bar,
body:not(.content-loaded) #active-users-panel,
body:not(.content-loaded) #active-users-toggle,
body:not(.content-loaded) .page,
body:not(.content-loaded) .control-panel,
body:not(.content-loaded) .sheet,
body:not(.content-loaded) table,
body:not(.content-loaded) .mobile-warning {
  opacity: 0 !important;
  visibility: hidden !important;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†å¾Œï¼šãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
body.content-loaded .nav-bar,
body.content-loaded #active-users-panel,
body.content-loaded #active-users-toggle,
body.content-loaded .page,
body.content-loaded .control-panel,
body.content-loaded .sheet,
body.content-loaded table,
body.content-loaded .mobile-warning {
  opacity: 1 !important;
  visibility: visible !important;
  transition: opacity 0.5s ease !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå›ºå®š */
table.selectable-table {
  table-layout: fixed !important;
  border-collapse: collapse !important;
  width: 100% !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ç½«ç·šã®æ˜ç¤ºçš„ãªå®šç¾© - æ¿ƒã„è‰² + è¡Œé–“èª¿æ•´ */
table.selectable-table thead th {
  border: 1px solid #999 !important;
  border-bottom: 2px solid #666 !important;
  padding: 10px 6px !important;
  line-height: 1.4 !important;
  vertical-align: middle !important;
}

/* ã™ã¹ã¦ã®tdè¦ç´ ã«å¼·åˆ¶é©ç”¨ */
table td {
  padding: 10px 6px !important;
  min-height: 60px !important;
  height: auto !important;
  vertical-align: middle !important;
  line-height: 1.4 !important;
}

/* ãƒ‡ãƒ¼ã‚¿è¡Œï¼šåŸºæœ¬è¨­å®š */
table.selectable-table tbody td {
  border: 1px solid #999 !important;
  padding: 10px 6px !important;
  line-height: 1.4 !important;
  min-height: 60px !important;
  height: auto !important;
  max-height: none !important;
  vertical-align: middle !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
}

/* ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šå‚™è€ƒåˆ—ä»¥å¤–ã¯æ¨ªæ–¹å‘ä¸­å¤®æƒãˆ */
#main-table tbody td:not(:last-child) {
  text-align: center !important;
}

/* ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šå‚™è€ƒåˆ—ï¼ˆæœ€å¾Œã®åˆ—ï¼‰ã¯æ¨ªæ–¹å‘å·¦æƒãˆ */
#main-table tbody td:last-child {
  text-align: left !important;
}

/* é–¢é€£æ–½è¨­ãƒ»æ¥­è€…æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šã™ã¹ã¦æ¨ªæ–¹å‘å·¦æƒãˆ */
#facilities-table tbody td,
#vendors-table tbody td {
  text-align: left !important;
}

table.selectable-table tbody tr:first-child td {
  border-top: 1px solid #999 !important;
}

/* theadã¨tbodyã®å¢ƒç•Œç·šã‚’ç¢ºå®Ÿã«è¡¨ç¤º - æ¿ƒã„è‰² */
table.selectable-table thead {
  border-bottom: 2px solid #666 !important;
}

table.selectable-table tbody {
  border-top: 1px solid #999 !important;
}

/* ãƒšãƒ¼ã‚¸å…¨ä½“ã®åˆæœŸçŠ¶æ…‹ */
body {
  overflow: hidden;
}

body.content-loaded {
  overflow: auto;
}

/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®selectã‚’å›ºå®šé«˜ã•ã« */
.control-panel select {
  height: 32px !important;
  min-height: 32px !important;
  max-height: 32px !important;
  line-height: 1.5 !important;
  box-sizing: border-box !important;
}
</style>
</head>
<body>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
<div id="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <p style="font-size: 18px; font-weight: 600; margin: 0;">ç—…é™¢æƒ…å ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
    <p style="font-size: 14px; margin-top: 10px; opacity: 0.9;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<div class="mobile-warning" id="mobile-warning">
  ğŸ“± PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚ã‚¹ãƒãƒ›ã§ã¯é–²è¦§ãƒ»åŸºæœ¬ç·¨é›†ã®ã¿å¯èƒ½ã§ã™ã€‚
</div>

<div class="nav-bar">
  <button id="tab-main" class="active" onclick="showPage('main')">ç—…é™¢æƒ…å ±ãƒªã‚¹ãƒˆ</button>
  <button id="tab-facilities" onclick="showPage('facilities')">é–¢é€£æ–½è¨­ãƒ»æ¥­è€…æƒ…å ±</button>
  <button id="tab-history" onclick="window.location.href='/history'" style="margin-left: 10px; background: rgba(102, 126, 234, 0.9); transition: background 0.3s;" onmouseover="this.style.background='rgba(85, 104, 211, 1)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.9)'">ğŸ“œ å¤‰æ›´å±¥æ­´</button>
  
  <span id="current-user-display" style="margin-left: 20px; padding: 6px 12px; background: rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 13px; font-weight: 600;">
    ğŸ‘¤ <span id="username-text">èª­è¾¼ä¸­...</span>
  </span>
  
  <span id="admin-menu" style="display: none;">
    <a href="/user_management" style="padding:6px 12px; background:#dc3545; color:#fff; text-decoration:none; border-radius:4px; font-size:13px; font-weight:600; margin-left:10px;">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
  </span>
  
  <a href="/change_password" style="padding:6px 12px; background:#6c757d; color:#fff; text-decoration:none; border-radius:4px; font-size:13px; font-weight:600; margin-left:10px;">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</a>
  <a href="/logout" id="logout-link" class="logout-link">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
</div>

<div id="active-users-panel">
  <h4 style="margin: 0 0 10px; font-size: 14px; color: #333;">ğŸ“‹ ä½œæ¥­ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</h4>
  <div id="active-users-list" style="font-size: 12px; color: #666;"></div>
</div>

<button id="active-users-toggle" onclick="toggleActiveUsersPanel()">
  ğŸ‘¥ ä½œæ¥­ä¸­ (<span id="active-users-count">0</span>)
</button>

<div id="page-main" class="page main-page active">
  <div class="control-panel">
    <label style="display: none;"> CSV:<input id="mdataFile" type="file" accept=".csv"></label>
    <label> éƒ½é“åºœçœŒ:
      <select id="prefSelect"><option value="">é¸æŠ</option></select>
    </label>
    <label> ç—…é™¢ï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰:
      <select id="codeSelect" disabled><option value="">é¸æŠ</option></select>
    </label>
    <button id="testBtn" class="test" onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <button id="fillBtn" disabled onclick="fillFromServer()">è»¢è¨˜</button>
    <button id="saveBtn" disabled onclick="saveToServer()">ä¿å­˜</button>
    <button id="clearBtn" class="clear" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
    <span id="status">CSV ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰è»¢è¨˜ã—ã¦ãã ã•ã„ã€‚</span>
  </div>

  <div class="sheet">
    <div class="top">
      <h1 class="title">ç—…é™¢æƒ…å ±ãƒªã‚¹ãƒˆ</h1>
      <div class="meta">
        <div class="row1">
          <div class="label">ã‚³ãƒ¼ãƒ‰</div><div class="value editable" contenteditable="plaintext-only" id="v-code">â€”</div>
          <div class="label">éƒ½é“åºœçœŒ</div><div class="value editable" contenteditable="plaintext-only" id="v-pref">â€”</div>
          <div class="label">ç—…é™¢å</div><div class="value editable" contenteditable="plaintext-only" id="v-hospital">â€”</div>
        </div>
        <div class="row2">
          <div class="label">ã€’ä½æ‰€</div><div class="value zip editable" contenteditable="plaintext-only" id="v-zip">â€”</div>
          <div class="value editable" contenteditable="plaintext-only" id="v-addr">â€”</div>
          <div class="label">æœ€å¯„é§…</div><div class="value editable" contenteditable="plaintext-only" id="v-station">â€”</div>
        </div>
        <div class="row3">
          <div class="label">TEL / DI</div><div class="value editable" contenteditable="plaintext-only" id="v-teldi">â€”</div>
          <div class="label">ãƒ•ã‚¡ãƒŸãƒ¬ã‚¹</div><div class="value editable" contenteditable="plaintext-only" id="v-family">â€”</div>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <div style="position: relative;">
        <div class="selection-info" id="selection-info"></div>
        <table class="selectable-table" id="main-table">
          <colgroup><col style="width:50px;"><col style="width:50px;"><col style="width:110px;"><col style="width:60px;"><col style="width:60px;"><col style="width:85px;"><col style="width:50px;"><col style="width:50px;"><col></colgroup>
          <thead><tr><th>å°</th><th>å’æ¥­</th><th>Dr. ï¼ å‡ºèº«å¤§å­¦</th><th>è¨ºç™‚ç§‘</th><th>PHS</th><th>ç›´PHS</th><th>â‘ </th><th>â‘¡</th><th>å‚™è€ƒ</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="table-controls">
        <div>
          <button onclick="addTableRows('main', 1)">+1è¡Œ</button>
          <button onclick="addTableRows('main', 5)">+5è¡Œ</button>
          <button onclick="addTableRows('main', 10)">+10è¡Œ</button>
          <span style="display:inline-block;width:16px"></span>
          <button onclick="addTableRows('main', 1)">-1è¡Œ</button>
          <button onclick="removeTableRows('main', 5)">-5è¡Œ</button>
        </div>
        <div style="font-size: 12px; color: #666; margin-top:8px;">ç¾åœ¨: <span id="main-row-count" style="font-weight: bold; color: #007bff;">0</span>è¡Œ</div>
      </div>
    </div>
  </div>
</div>

<div id="page-facilities" class="page facilities-page">
  <div class="control-panel">
    <span style="font-weight:bold;">é–¢é€£æ–½è¨­ãƒ»æ¥­è€…æƒ…å ±</span>
    <button id="fillBtn2" disabled onclick="fillFromServer()">è»¢è¨˜</button>
    <button id="saveBtn2" disabled onclick="saveToServer()">ä¿å­˜</button>
    <span id="status2">1ãƒšãƒ¼ã‚¸ç›®ã§è»¢è¨˜ã™ã‚‹ã¨ã€ã“ã¡ã‚‰ã«ã‚‚è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚</span>
  </div>

  <div class="sheet">
    <div class="top">
      <h1 class="title">é–¢é€£æ–½è¨­ãƒ»æ¥­è€…æƒ…å ±</h1>
      <div class="meta">
        <div class="row1"><div class="label">ã‚³ãƒ¼ãƒ‰</div><div class="value editable" contenteditable="plaintext-only" id="v2-code">â€”</div><div class="label">ç—…é™¢å</div><div class="value editable" contenteditable="plaintext-only" id="v2-hospital">â€”</div></div>
        <div class="row2"><div class="label">TEL</div><div class="value editable" contenteditable="plaintext-only" id="v2-tel">â€”</div><div class="label">DI</div><div class="value editable" contenteditable="plaintext-only" id="v2-di">â€”</div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">é–¢é€£ç—…é™¢æ–½è¨­æƒ…å ±</div>
      <div class="table-wrap facilities">
        <div style="position: relative;">
          <div class="selection-info" id="selection-info-facilities"></div>
          <table class="selectable-table" id="facilities-table">
            <colgroup><col style="width:150px;"><col style="width:120px;"><col></colgroup>
            <thead><tr><th>é–¢é€£ç—…é™¢æ–½è¨­ç­‰</th><th>é–¢é€£ç—…é™¢TEL</th><th>é–¢é€£ç—…é™¢å‚™è€ƒ</th></tr></thead>
            <tbody id="facilities-tbody"></tbody>
          </table>
        </div>
        <div class="table-controls">
          <div>
            <button onclick="addTableRows('facilities', 1)">+1è¡Œ</button>
            <button onclick="addTableRows('facilities', 5)">+5è¡Œ</button>
            <span style="display:inline-block;width:16px"></span>
            <button onclick="removeTableRows('facilities', 1)">-1è¡Œ</button>
            <button onclick="removeTableRows('facilities', 5)">-5è¡Œ</button>
          </div>
          <div style="font-size: 12px; color: #666; margin-top:8px;">ç¾åœ¨: <span id="facilities-row-count" style="font-weight: bold; color: #007bff;">0</span>è¡Œ</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">æ¥­è€…ãƒ»éƒ¨ç½²æƒ…å ±</div>
      <div class="table-wrap facilities">
        <div style="position: relative;">
          <div class="selection-info" id="selection-info-vendors"></div>
          <table class="selectable-table" id="vendors-table">
            <colgroup><col style="width:100px;"><col style="width:120px;"><col style="width:80px;"><col></colgroup>
            <thead><tr><th>éƒ¨ç½²</th><th>æ¥­è€…</th><th>å†…ç·š</th><th>TELãƒ»ãƒ¡ãƒ¢</th></tr></thead>
            <tbody id="vendors-tbody"></tbody>
          </table>
        </div>
        <div class="table-controls">
          <div>
            <button onclick="addTableRows('vendors', 1)">+1è¡Œ</button>
            <button onclick="addTableRows('vendors', 5)">+5è¡Œ</button>
            <span style="display:inline-block;width:16px"></span>
            <button onclick="removeTableRows('vendors', 1)">-1è¡Œ</button>
            <button onclick="removeTableRows('vendors', 5)">-5è¡Œ</button>
          </div>
          <div style="font-size: 12px; color: #666; margin-top:8px;">ç¾åœ¨: <span id="vendors-row-count" style="font-weight: bold; color: #007bff;">0</span>è¡Œ</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script src="js/lock.js"></script>
<script src="js/table.js"></script>
<script src="js/excel.js"></script>
<script src="js/ui.js"></script>
<script src="js/main.js"></script>

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†å‡¦ç† -->
<script>
(function() {
  'use strict';
  
  // åˆæœŸçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
  document.body.style.overflow = 'hidden';
  
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
  function hideLoading() {
    console.log('ğŸ‰ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.add('fade-out');
      
      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œã«å‰Šé™¤
      setTimeout(function() {
        overlay.style.display = 'none';
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        document.body.classList.add('content-loaded');
        document.body.style.overflow = 'auto';
        
        console.log('âœ… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºå®Œäº†');
      }, 300);
    } else {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ãŒãªã„å ´åˆã‚‚å‡¦ç†
      document.body.classList.add('content-loaded');
      document.body.style.overflow = 'auto';
    }
  }
  
  // è¤‡æ•°ã®æ–¹æ³•ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†ã‚’æ¤œçŸ¥
  if (document.readyState === 'complete') {
    // æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿
    setTimeout(hideLoading, 300);
  } else {
    // èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
    window.addEventListener('load', function() {
      setTimeout(hideLoading, 300);
    });
    
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼š3ç§’çµŒã£ã¦ã‚‚å®Œäº†ã—ãªã„å ´åˆã¯å¼·åˆ¶è¡¨ç¤º
    setTimeout(function() {
      if (!document.body.classList.contains('content-loaded')) {
        console.warn('âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šå¼·åˆ¶çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º');
        hideLoading();
      }
    }, 3000);
  }
  
  // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å¿…ãšãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã™
  window.addEventListener('error', function(e) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', e);
    hideLoading();
  });
})();
</script>

</body>
</html>