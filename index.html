<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>病院情報管理システム</title>

<!-- CSS -->
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/table.css">
<link rel="stylesheet" href="/css/responsive.css">

<!-- インラインCSS：初期表示制御 -->
<style>
/* CSS変数の上書き - 最優先 */
:root {
  --rowh: 60px !important;
  --fac-rowh: 60px !important;
  --line: 1px solid #999;
}

/* ローディング画面 - 最優先 */
#loading-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  z-index: 99999 !important;
  transition: opacity 0.3s ease !important;
}

#loading-overlay.fade-out {
  opacity: 0 !important;
  pointer-events: none !important;
}

.loading-content {
  text-align: center;
  color: white;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 初期状態：すべてのコンテンツを非表示 */
body:not(.content-loaded) .nav-bar,
body:not(.content-loaded) #active-users-panel,
body:not(.content-loaded) #active-users-toggle,
body:not(.content-loaded) .page,
body:not(.content-loaded) .control-panel,
body:not(.content-loaded) .sheet,
body:not(.content-loaded) table,
body:not(.content-loaded) .mobile-warning {
  opacity: 0 !important;
  visibility: hidden !important;
}

/* ローディング完了後：フェードイン */
body.content-loaded .nav-bar,
body.content-loaded #active-users-panel,
body.content-loaded #active-users-toggle,
body.content-loaded .page,
body.content-loaded .control-panel,
body.content-loaded .sheet,
body.content-loaded table,
body.content-loaded .mobile-warning {
  opacity: 1 !important;
  visibility: visible !important;
  transition: opacity 0.5s ease !important;
}

/* テーブルの初期レイアウト固定 */
table.selectable-table {
  table-layout: fixed !important;
  border-collapse: collapse !important;
  width: 100% !important;
}

/* テーブル罫線の明示的な定義 - 濃い色 + 行間調整 */
table.selectable-table thead th {
  border: 1px solid #999 !important;
  border-bottom: 2px solid #666 !important;
  padding: 10px 6px !important;
  line-height: 1.4 !important;
  vertical-align: middle !important;
}

/* すべてのtd要素に強制適用 */
table td {
  padding: 10px 6px !important;
  min-height: 60px !important;
  height: auto !important;
  vertical-align: middle !important;
  line-height: 1.4 !important;
}

/* データ行：基本設定 */
table.selectable-table tbody td {
  border: 1px solid #999 !important;
  padding: 10px 6px !important;
  line-height: 1.4 !important;
  min-height: 60px !important;
  height: auto !important;
  max-height: none !important;
  vertical-align: middle !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
}

/* メインテーブル：備考列以外は横方向中央揃え */
#main-table tbody td:not(:last-child) {
  text-align: center !important;
}

/* メインテーブル：備考列（最後の列）は横方向左揃え */
#main-table tbody td:last-child {
  text-align: left !important;
}

/* 関連施設・業者情報テーブル：すべて横方向左揃え */
#facilities-table tbody td,
#vendors-table tbody td {
  text-align: left !important;
}

table.selectable-table tbody tr:first-child td {
  border-top: 1px solid #999 !important;
}

/* theadとtbodyの境界線を確実に表示 - 濃い色 */
table.selectable-table thead {
  border-bottom: 2px solid #666 !important;
}

table.selectable-table tbody {
  border-top: 1px solid #999 !important;
}

/* ページ全体の初期状態 */
body {
  overflow: hidden;
}

body.content-loaded {
  overflow: auto;
}

/* コントロールパネルのselectを固定高さに */
.control-panel select {
  height: 32px !important;
  min-height: 32px !important;
  max-height: 32px !important;
  line-height: 1.5 !important;
  box-sizing: border-box !important;
}
</style>
</head>
<body>

<!-- ローディング画面 -->
<div id="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <p style="font-size: 18px; font-weight: 600; margin: 0;">病院情報管理システム</p>
    <p style="font-size: 14px; margin-top: 10px; opacity: 0.9;">読み込み中...</p>
  </div>
</div>

<div class="mobile-warning" id="mobile-warning">
  📱 PC/タブレットでの使用を推奨します。スマホでは閲覧・基本編集のみ可能です。
</div>

<div class="nav-bar">
  <button id="tab-main" class="active" onclick="showPage('main')">病院情報リスト</button>
  <button id="tab-facilities" onclick="showPage('facilities')">関連施設・業者情報</button>
  <button id="tab-history" onclick="window.location.href='/history'" style="margin-left: 10px; background: rgba(102, 126, 234, 0.9); transition: background 0.3s;" onmouseover="this.style.background='rgba(85, 104, 211, 1)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.9)'">📜 変更履歴</button>
  
  <span id="current-user-display" style="margin-left: 20px; padding: 6px 12px; background: rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 13px; font-weight: 600;">
    👤 <span id="username-text">読込中...</span>
  </span>
  
  <span id="admin-menu" style="display: none;">
    <a href="/user_management" style="padding:6px 12px; background:#dc3545; color:#fff; text-decoration:none; border-radius:4px; font-size:13px; font-weight:600; margin-left:10px;">👥 ユーザー管理</a>
  </span>
  
  <a href="/change_password" style="padding:6px 12px; background:#6c757d; color:#fff; text-decoration:none; border-radius:4px; font-size:13px; font-weight:600; margin-left:10px;">🔐 パスワード変更</a>
  <a href="/logout" id="logout-link" class="logout-link">ログアウト</a>
</div>

<div id="active-users-panel">
  <h4 style="margin: 0 0 10px; font-size: 14px; color: #333;">📋 作業中のユーザー</h4>
  <div id="active-users-list" style="font-size: 12px; color: #666;"></div>
</div>

<button id="active-users-toggle" onclick="toggleActiveUsersPanel()">
  👥 作業中 (<span id="active-users-count">0</span>)
</button>

<div id="page-main" class="page main-page active">
  <div class="control-panel">
    <label style="display: none;"> CSV:<input id="mdataFile" type="file" accept=".csv"></label>
    <label> 都道府県:
      <select id="prefSelect"><option value="">選択</option></select>
    </label>
    <label> 病院（コード）:
      <select id="codeSelect" disabled><option value="">選択</option></select>
    </label>
    <button id="testBtn" class="test" onclick="testConnection()">接続テスト</button>
    <button id="fillBtn" disabled onclick="fillFromServer()">転記</button>
    <button id="saveBtn" disabled onclick="saveToServer()">保存</button>
    <button id="clearBtn" class="clear" onclick="clearForm()">クリア</button>
    <span id="status">CSV を読み込んでから転記してください。</span>
  </div>

  <div class="sheet">
    <div class="top">
      <h1 class="title">病院情報リスト</h1>
      <div class="meta">
        <div class="row1">
          <div class="label">コード</div><div class="value editable" contenteditable="plaintext-only" id="v-code">—</div>
          <div class="label">都道府県</div><div class="value editable" contenteditable="plaintext-only" id="v-pref">—</div>
          <div class="label">病院名</div><div class="value editable" contenteditable="plaintext-only" id="v-hospital">—</div>
        </div>
        <div class="row2">
          <div class="label">〒住所</div><div class="value zip editable" contenteditable="plaintext-only" id="v-zip">—</div>
          <div class="value editable" contenteditable="plaintext-only" id="v-addr">—</div>
          <div class="label">最寄駅</div><div class="value editable" contenteditable="plaintext-only" id="v-station">—</div>
        </div>
        <div class="row3">
          <div class="label">TEL / DI</div><div class="value editable" contenteditable="plaintext-only" id="v-teldi">—</div>
          <div class="label">ファミレス</div><div class="value editable" contenteditable="plaintext-only" id="v-family">—</div>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <div style="position: relative;">
        <div class="selection-info" id="selection-info"></div>
        <table class="selectable-table" id="main-table">
          <colgroup><col style="width:50px;"><col style="width:50px;"><col style="width:110px;"><col style="width:60px;"><col style="width:60px;"><col style="width:85px;"><col style="width:50px;"><col style="width:50px;"><col></colgroup>
          <thead><tr><th>印</th><th>卒業</th><th>Dr. ／ 出身大学</th><th>診療科</th><th>PHS</th><th>直PHS</th><th>①</th><th>②</th><th>備考</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="table-controls">
        <div>
          <button onclick="addTableRows('main', 1)">+1行</button>
          <button onclick="addTableRows('main', 5)">+5行</button>
          <button onclick="addTableRows('main', 10)">+10行</button>
          <span style="display:inline-block;width:16px"></span>
          <button onclick="addTableRows('main', 1)">-1行</button>
          <button onclick="removeTableRows('main', 5)">-5行</button>
        </div>
        <div style="font-size: 12px; color: #666; margin-top:8px;">現在: <span id="main-row-count" style="font-weight: bold; color: #007bff;">0</span>行</div>
      </div>
    </div>
  </div>
</div>

<div id="page-facilities" class="page facilities-page">
  <div class="control-panel">
    <span style="font-weight:bold;">関連施設・業者情報</span>
    <button id="fillBtn2" disabled onclick="fillFromServer()">転記</button>
    <button id="saveBtn2" disabled onclick="saveToServer()">保存</button>
    <span id="status2">1ページ目で転記すると、こちらにも自動反映されます。</span>
  </div>

  <div class="sheet">
    <div class="top">
      <h1 class="title">関連施設・業者情報</h1>
      <div class="meta">
        <div class="row1"><div class="label">コード</div><div class="value editable" contenteditable="plaintext-only" id="v2-code">—</div><div class="label">病院名</div><div class="value editable" contenteditable="plaintext-only" id="v2-hospital">—</div></div>
        <div class="row2"><div class="label">TEL</div><div class="value editable" contenteditable="plaintext-only" id="v2-tel">—</div><div class="label">DI</div><div class="value editable" contenteditable="plaintext-only" id="v2-di">—</div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">関連病院施設情報</div>
      <div class="table-wrap facilities">
        <div style="position: relative;">
          <div class="selection-info" id="selection-info-facilities"></div>
          <table class="selectable-table" id="facilities-table">
            <colgroup><col style="width:150px;"><col style="width:120px;"><col></colgroup>
            <thead><tr><th>関連病院施設等</th><th>関連病院TEL</th><th>関連病院備考</th></tr></thead>
            <tbody id="facilities-tbody"></tbody>
          </table>
        </div>
        <div class="table-controls">
          <div>
            <button onclick="addTableRows('facilities', 1)">+1行</button>
            <button onclick="addTableRows('facilities', 5)">+5行</button>
            <span style="display:inline-block;width:16px"></span>
            <button onclick="removeTableRows('facilities', 1)">-1行</button>
            <button onclick="removeTableRows('facilities', 5)">-5行</button>
          </div>
          <div style="font-size: 12px; color: #666; margin-top:8px;">現在: <span id="facilities-row-count" style="font-weight: bold; color: #007bff;">0</span>行</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">業者・部署情報</div>
      <div class="table-wrap facilities">
        <div style="position: relative;">
          <div class="selection-info" id="selection-info-vendors"></div>
          <table class="selectable-table" id="vendors-table">
            <colgroup><col style="width:100px;"><col style="width:120px;"><col style="width:80px;"><col></colgroup>
            <thead><tr><th>部署</th><th>業者</th><th>内線</th><th>TEL・メモ</th></tr></thead>
            <tbody id="vendors-tbody"></tbody>
          </table>
        </div>
        <div class="table-controls">
          <div>
            <button onclick="addTableRows('vendors', 1)">+1行</button>
            <button onclick="addTableRows('vendors', 5)">+5行</button>
            <span style="display:inline-block;width:16px"></span>
            <button onclick="removeTableRows('vendors', 1)">-1行</button>
            <button onclick="removeTableRows('vendors', 5)">-5行</button>
          </div>
          <div style="font-size: 12px; color: #666; margin-top:8px;">現在: <span id="vendors-row-count" style="font-weight: bold; color: #007bff;">0</span>行</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script src="js/lock.js"></script>
<script src="js/table.js"></script>
<script src="js/excel.js"></script>
<script src="js/ui.js"></script>
<script src="js/main.js"></script>

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>

<!-- ローディング完了処理 -->
<script>
(function() {
  'use strict';
  
  // 初期状態を確実に設定
  document.body.style.overflow = 'hidden';
  
  // ページ読み込み完了を待つ
  function hideLoading() {
    console.log('🎉 ページ読み込み完了');
    
    // ローディングを非表示
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.add('fade-out');
      
      // フェードアウト後に削除
      setTimeout(function() {
        overlay.style.display = 'none';
        
        // コンテンツを表示
        document.body.classList.add('content-loaded');
        document.body.style.overflow = 'auto';
        
        console.log('✅ コンテンツ表示完了');
      }, 300);
    } else {
      // ローディング要素がない場合も処理
      document.body.classList.add('content-loaded');
      document.body.style.overflow = 'auto';
    }
  }
  
  // 複数の方法でローディング完了を検知
  if (document.readyState === 'complete') {
    // 既に読み込み済み
    setTimeout(hideLoading, 300);
  } else {
    // 読み込み完了を待つ
    window.addEventListener('load', function() {
      setTimeout(hideLoading, 300);
    });
    
    // タイムアウト：3秒経っても完了しない場合は強制表示
    setTimeout(function() {
      if (!document.body.classList.contains('content-loaded')) {
        console.warn('⚠️ タイムアウト：強制的にコンテンツを表示');
        hideLoading();
      }
    }, 3000);
  }
  
  // エラー時も必ずローディングを消す
  window.addEventListener('error', function(e) {
    console.error('❌ エラー発生:', e);
    hideLoading();
  });
})();
</script>

</body>
</html>